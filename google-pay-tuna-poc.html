<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POC - Google Pay via Tuna</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .info-box {
            background: #f5f5f5;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-bottom: 30px;
            border-radius: 4px;
        }

        .info-box p {
            color: #555;
            font-size: 13px;
            line-height: 1.6;
        }

        .info-box code {
            background: #e0e0e0;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 12px;
        }

        #googlePayButtonContainer {
            margin: 30px 0;
            min-height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .status {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }

        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            display: block;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            display: block;
        }

        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
            display: block;
        }

        .console-log {
            margin-top: 20px;
            padding: 15px;
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }

        .console-log .log-entry {
            margin-bottom: 8px;
            padding: 5px;
            border-left: 3px solid transparent;
        }

        .console-log .log-entry.success {
            border-left-color: #4caf50;
        }

        .console-log .log-entry.error {
            border-left-color: #f44336;
        }

        .console-log .log-entry.info {
            border-left-color: #2196f3;
        }

        .loading {
            text-align: center;
            color: #666;
            margin: 20px 0;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üöÄ POC Google Pay via Tuna</h1>
        <p class="subtitle">Prova de Conceito - Integra√ß√£o Tuna + Google Pay</p>

        <div class="info-box">
            <p><strong>‚ö†Ô∏è Nota:</strong> Esta √© uma POC para teste visual. Configure a URL da API e o Restaurant ID abaixo.</p>
        </div>

        <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <label style="display: block; margin-bottom: 15px;">
                <strong>API URL:</strong>
                <input type="text" id="apiUrl" value="http://multipedidos.beta" style="width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 14px;">
            </label>
            <label style="display: block; margin-bottom: 15px;">
                <strong>Restaurant ID:</strong>
                <input type="number" id="restaurantId" value="1" style="width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 14px;">
            </label>
            <label style="display: block; margin-bottom: 15px;">
                <strong>Ambiente Tuna:</strong>
                <select id="tunaEnvironment" style="width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-size: 14px;">
                    <option value="production">Produ√ß√£o</option>
                    <option value="sandbox">Sandbox</option>
                    <option value="auto">Autom√°tico (sem par√¢metro)</option>
                </select>
            </label>
            <label style="display: block; margin-top: 10px; margin-bottom: 15px;">
                <input type="checkbox" id="useMockSession" style="width: auto; margin-right: 8px;">
                <strong>Usar Session Mock (tempor√°rio)</strong>
            </label>
            <button onclick="initTuna()" style="margin-top: 15px; padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; font-weight: bold; width: 100%;">
                üöÄ Carregar Google Pay
            </button>
        </div>

        <div id="googlePayButtonContainer">
            <div class="loading">
                <p>Configure os dados acima e clique em "Carregar Google Pay"</p>
            </div>
        </div>

        <div id="status" class="status"></div>

        <div class="console-log" id="consoleLog">
            <div class="log-entry info">Console de logs aparecer√° aqui...</div>
        </div>
    </div>

    <!-- Tuna SDK v2 - Vers√£o mais atualizada -->
    <script src="https://storage.googleapis.com/tuna-statics/tuna-v2.js"></script>
    <!-- CSS opcional da Tuna -->
    <link rel="stylesheet" href="https://js.tuna.uy/css/components.css">

    <script>
        // Fun√ß√£o auxiliar para logar no console e na UI
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            const consoleLog = document.getElementById('consoleLog');
            consoleLog.insertBefore(logEntry, consoleLog.firstChild);
            
            // Manter apenas os √∫ltimos 10 logs
            while (consoleLog.children.length > 10) {
                consoleLog.removeChild(consoleLog.lastChild);
            }

            // Log tamb√©m no console do navegador
            if (type === 'error') {
                console.error(message);
            } else if (type === 'success') {
                console.log('‚úÖ', message);
            } else {
                console.log('‚ÑπÔ∏è', message);
            }
        }

        // Fun√ß√£o para atualizar status
        function updateStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
        }

        // Configura√ß√µes do Google Pay
        const GOOGLE_PAY_CONFIG = {
            merchantId: 'BCR2DN6TR7QYLIKK',
            merchantName: 'Teste POC Tuna',
            gatewayMerchantId: '78c30483-2a55-422e-98f1-b68f77fcaa70'
        };

        // Configura√ß√£o da transa√ß√£o (valores de teste)
        const TRANSACTION_INFO = {
            totalPriceStatus: 'FINAL',
            totalPrice: '1.00',
            currencyCode: 'BRL'
        };

        // SessionId mock tempor√°rio
        const MOCK_SESSION_ID = 'tPfDU4Pz2dq6xfMHnDdIY2UR4o15yN/xFVEiHb+nblTJQq7Q5wlpO37/A2vswsHKFq21jKOlwKu61+ZT1uJoqzOT9x6tqmWy8ygnip0q7SB5B0xz';

        // Fun√ß√£o para obter sessionId da API
        async function getSessionId(apiUrl, restaurantId) {
            try {
                log(`Fazendo requisi√ß√£o para: ${apiUrl}/restaurant/tuna/session`, 'info');
                log(`Restaurant ID: ${restaurantId}`, 'info');
                
                const response = await fetch(`${apiUrl}/restaurant/tuna/session`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        restaurantId: parseInt(restaurantId)
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Erro HTTP ${response.status}: ${errorText || response.statusText}`);
                }

                const data = await response.json();
                log('Resposta da API recebida: ' + JSON.stringify(data), 'success');
                
                if (data.sessionId) {
                    log(`‚úÖ SessionId obtido: ${data.sessionId}`, 'success');
                    return data.sessionId;
                } else {
                    throw new Error('SessionId n√£o encontrado na resposta da API');
                }
            } catch (error) {
                log(`‚ùå Erro ao obter sessionId: ${error.message}`, 'error');
                throw error;
            }
        }

        // Aguardar o SDK da Tuna carregar
        async function initTuna() {
            const apiUrl = document.getElementById('apiUrl').value.trim();
            const restaurantId = document.getElementById('restaurantId').value.trim();
            const tunaEnvironment = document.getElementById('tunaEnvironment').value;
            const useMockSession = document.getElementById('useMockSession').checked;
            
            if (!useMockSession && (!apiUrl || !restaurantId)) {
                updateStatus('‚ùå Por favor, preencha a URL da API e o Restaurant ID', 'error');
                return;
            }

            // Limpar logs anteriores
            document.getElementById('consoleLog').innerHTML = '';
            updateStatus('', '');
            
            const container = document.getElementById('googlePayButtonContainer');
            container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Obtendo sessionId...</p></div>';
            
            log('Iniciando processo de carregamento do Google Pay...', 'info');
            try {
                // Obter sessionId da API ou usar mock
                let SESSION_ID;
                if (useMockSession) {
                    log('‚ö†Ô∏è Usando SessionId MOCK (tempor√°rio)', 'info');
                    SESSION_ID = MOCK_SESSION_ID;
                    log(`SessionId mock: ${SESSION_ID}`, 'info');
                } else {
                    log('Buscando sessionId da API...', 'info');
                    SESSION_ID = await getSessionId(apiUrl, restaurantId);
                }
                
                // Verificar se Tuna SDK est√° dispon√≠vel
                log('Verificando se Tuna SDK est√° dispon√≠vel...', 'info');
                
                if (typeof Tuna === 'undefined') {
                    throw new Error('Tuna SDK n√£o foi carregado. Verifique se o script foi carregado corretamente.');
                }

                log('Tuna SDK carregado com sucesso!', 'success');
                log(`Inicializando Tuna com sessionId real: ${SESSION_ID}`, 'info');

                // Tentar diferentes formas de inicializa√ß√£o baseado no ambiente selecionado
                let tuna;
                
                if (tunaEnvironment === 'auto') {
                    // Tentar primeiro sem par√¢metro de ambiente (o sessionId pode indicar o ambiente)
                    try {
                        tuna = Tuna(SESSION_ID);
                        log('Tuna inicializado com: Tuna(sessionId) - ambiente autom√°tico', 'success');
                    } catch (e1) {
                        log('Tentativa autom√°tica falhou, tentando com production...', 'info');
                        try {
                            tuna = Tuna(SESSION_ID, 'production');
                            log('Tuna inicializado com: Tuna(sessionId, "production")', 'success');
                        } catch (e2) {
                            log('Tentativa com production falhou, tentando com sandbox...', 'info');
                            try {
                                tuna = Tuna(SESSION_ID, 'sandbox');
                                log('Tuna inicializado com: Tuna(sessionId, "sandbox")', 'success');
                            } catch (e3) {
                                log('Todas as formas de inicializa√ß√£o falharam', 'error');
                                throw e3;
                            }
                        }
                    }
                } else {
                    // Usar o ambiente especificado pelo usu√°rio
                    try {
                        tuna = Tuna(SESSION_ID, tunaEnvironment);
                        log(`Tuna inicializado com: Tuna(sessionId, "${tunaEnvironment}")`, 'success');
                    } catch (e1) {
                        log(`Tentativa com ${tunaEnvironment} falhou, tentando sem par√¢metro...`, 'info');
                        try {
                            tuna = Tuna(SESSION_ID);
                            log('Tuna inicializado com: Tuna(sessionId) - sem ambiente', 'success');
                        } catch (e2) {
                            log('Todas as formas de inicializa√ß√£o falharam', 'error');
                            throw e2;
                        }
                    }
                }
                
                // Debug: inspecionar objeto tuna
                log('Tipo do objeto tuna: ' + typeof tuna, 'info');
                log('M√©todos dispon√≠veis: ' + Object.keys(tuna).join(', '), 'info');
                log('useGooglePay existe? ' + (typeof tuna.useGooglePay === 'function' ? 'SIM' : 'N√ÉO'), 'info');
                
                // Listar todos os m√©todos dispon√≠veis
                const allMethods = Object.getOwnPropertyNames(tuna).filter(prop => typeof tuna[prop] === 'function');
                if (allMethods.length > 0) {
                    log('M√©todos encontrados: ' + allMethods.join(', '), 'info');
                }

                // Configurar Google Pay
                log('Configurando Google Pay...', 'info');
                
                // Objeto de configura√ß√£o conforme c√≥digo fonte da Tuna
                // A Tuna espera: cardAuthMethods e cardNetworks (obrigat√≥rios)
                // E opcionalmente: merchantId, merchantName e gatewayMerchantId
                const googlePayMerchantInfo = {
                    // Propriedades obrigat√≥rias (encontradas no c√≥digo fonte)
                    cardAuthMethods: ['PAN_ONLY', 'CRYPTOGRAM_3DS'],
                    cardNetworks: ['VISA', 'MASTERCARD', 'AMEX'],
                    // Propriedades opcionais do Google Pay
                    merchantId: GOOGLE_PAY_CONFIG.merchantId,
                    merchantName: GOOGLE_PAY_CONFIG.merchantName,
                    // Gateway Merchant ID da Tuna (necess√°rio para processar pagamentos)
                    gatewayMerchantId: GOOGLE_PAY_CONFIG.gatewayMerchantId
                };
                
                log('‚ö†Ô∏è Nota sobre OR_BIBED_11:', 'info');
                log('Este erro geralmente indica problema na configura√ß√£o do gateway.', 'info');
                log('Verifique se:', 'info');
                log('1. O gatewayMerchantId est√° correto: ' + GOOGLE_PAY_CONFIG.gatewayMerchantId, 'info');
                log('2. O merchantId do Google est√° correto: ' + GOOGLE_PAY_CONFIG.merchantId, 'info');
                log('3. A conta Google Pay est√° aprovada para produ√ß√£o', 'info');
                log('4. O gatewayMerchantId est√° configurado corretamente na conta Tuna', 'info');
                
                log('Configura√ß√£o do Google Pay (merchantInfo): ' + JSON.stringify(googlePayMerchantInfo, null, 2), 'info');
                log('Verificando propriedades obrigat√≥rias...', 'info');
                log('- cardAuthMethods: ' + (googlePayMerchantInfo.cardAuthMethods ? '‚úÖ (' + JSON.stringify(googlePayMerchantInfo.cardAuthMethods) + ')' : '‚ùå'), 'info');
                log('- cardNetworks: ' + (googlePayMerchantInfo.cardNetworks ? '‚úÖ (' + JSON.stringify(googlePayMerchantInfo.cardNetworks) + ')' : '‚ùå'), 'info');
                log('- merchantId: ' + (googlePayMerchantInfo.merchantId ? '‚úÖ (' + googlePayMerchantInfo.merchantId + ')' : '‚ö†Ô∏è (opcional)'), 'info');
                log('- merchantName: ' + (googlePayMerchantInfo.merchantName ? '‚úÖ (' + googlePayMerchantInfo.merchantName + ')' : '‚ö†Ô∏è (opcional)'), 'info');
                
                // Verificar se as propriedades obrigat√≥rias est√£o presentes
                if (!googlePayMerchantInfo.cardAuthMethods || !Array.isArray(googlePayMerchantInfo.cardAuthMethods) || googlePayMerchantInfo.cardAuthMethods.length === 0) {
                    throw new Error('cardAuthMethods √© obrigat√≥rio e deve ser um array n√£o vazio');
                }
                if (!googlePayMerchantInfo.cardNetworks || !Array.isArray(googlePayMerchantInfo.cardNetworks) || googlePayMerchantInfo.cardNetworks.length === 0) {
                    throw new Error('cardNetworks √© obrigat√≥rio e deve ser um array n√£o vazio');
                }

                // Callback de sucesso (obrigat√≥rio na v2)
                // Na v2, n√£o h√° callback de erro separado - erros devem ser tratados dentro do callback de sucesso
                const onSuccess = (paymentData) => {
                    try {
                        log('‚úÖ Pagamento processado com sucesso!', 'success');
                        log(`Dados do pagamento: ${JSON.stringify(paymentData, null, 2)}`, 'success');
                        updateStatus('‚úÖ Pagamento processado! Verifique o console para detalhes.', 'success');
                    } catch (error) {
                        log(`‚ùå Erro ao processar pagamento: ${error?.message || JSON.stringify(error)}`, 'error');
                        updateStatus(`‚ùå Erro: ${error?.message || 'Erro desconhecido'}`, 'error');
                    }
                };

                // Renderizar bot√£o do Google Pay
                // Nova assinatura v2: useGooglePay(container, merchantInfo, onSuccess, validationGroup?, transactionInfo?, param6?)
                // validationGroup pode ser string ou array de strings (opcional)
                // transactionInfo √© opcional
                if (typeof tuna.useGooglePay === 'function') {
                    log('M√©todo useGooglePay encontrado (v2)! Renderizando bot√£o...', 'success');
                    
                    // Log detalhado dos par√¢metros que ser√£o passados
                    log('Par√¢metros do useGooglePay (v2):', 'info');
                    log('1. Container: #googlePayButtonContainer', 'info');
                    log('2. merchantInfo: ' + JSON.stringify(googlePayMerchantInfo, null, 2), 'info');
                    log('3. onSuccess: callback function', 'info');
                    log('4. validationGroup: null (opcional)', 'info');
                    log('5. transactionInfo: ' + JSON.stringify(TRANSACTION_INFO, null, 2), 'info');
                    
                    console.log('ENVIADO ISSO (v2)', {
                        googlePayMerchantInfo,
                        TRANSACTION_INFO
                    });
                    
                    try {
                        // Nova assinatura v2: useGooglePay(container, merchantInfo, onSuccess, validationGroup?, transactionInfo?)
                        // validationGroup √© opcional (pode ser null, string ou array)
                        // transactionInfo √© opcional
                        log('Tentando renderizar com nova assinatura v2...', 'info');
                        tuna.useGooglePay(
                            '#googlePayButtonContainer',  // e: container selector
                            googlePayMerchantInfo,          // t: merchantInfo
                            onSuccess,                      // n: callback de sucesso (obrigat√≥rio)
                            null,                           // r: validationGroup (opcional, null)
                            TRANSACTION_INFO                // a: transactionInfo (opcional)
                        );
                        log('‚úÖ Bot√£o Google Pay renderizado com sucesso (v2)!', 'success');
                    } catch (apiError1) {
                        log('Erro com transactionInfo: ' + apiError1.message, 'error');
                        log('Tentando sem transactionInfo...', 'info');
                        try {
                            // Tentar sem transactionInfo
                            tuna.useGooglePay(
                                '#googlePayButtonContainer',
                                googlePayMerchantInfo,
                                onSuccess,
                                null  // validationGroup
                            );
                            log('‚úÖ Bot√£o Google Pay renderizado sem transactionInfo (v2)!', 'success');
                        } catch (apiError2) {
                            log('Erro sem transactionInfo: ' + apiError2.message, 'error');
                            log('Tentando apenas com par√¢metros obrigat√≥rios...', 'info');
                            try {
                                // Tentar apenas com par√¢metros obrigat√≥rios
                                tuna.useGooglePay(
                                    '#googlePayButtonContainer',
                                    googlePayMerchantInfo,
                                    onSuccess
                                );
                                log('‚úÖ Bot√£o Google Pay renderizado apenas com par√¢metros obrigat√≥rios (v2)!', 'success');
                            } catch (apiError3) {
                                log('‚ùå Erro em todas as tentativas: ' + apiError3.message, 'error');
                                throw apiError3;
                            }
                        }
                    }
                } else {
                    // M√©todo n√£o encontrado
                    const errorMsg = 'M√©todo useGooglePay n√£o encontrado no objeto tuna. Verifique o console para ver os m√©todos dispon√≠veis.';
                    log(errorMsg, 'error');
                    log('Objeto tuna completo: ' + JSON.stringify(tuna, null, 2), 'error');
                    updateStatus('‚ùå ' + errorMsg, 'error');
                    throw new Error(errorMsg);
                }

                updateStatus('‚úÖ Bot√£o Google Pay carregado. Clique para testar!', 'success');

                // Remover loading
                const loadingDiv = document.querySelector('.loading');
                if (loadingDiv) {
                    loadingDiv.style.display = 'none';
                }
            } catch (error) {
                log(`‚ùå Erro geral: ${error.message}`, 'error');
                updateStatus(`‚ùå Erro: ${error.message}`, 'error');
                container.innerHTML = `<p style="color: red;">Erro: ${error.message}</p>`;
                console.error('Erro completo:', error);
            }
        }

        // N√£o inicializar automaticamente - aguardar clique do usu√°rio
    </script>
</body>
</html>

